machine:
  environment:
    XCODE_SCHEME: test
    XCODE_WORKSPACE: test
    XCODE_PROJECT: test

  xcode:
    version: 7.3

  post:
    - defaults -currentHost write com.apple.screensaver idleTime 0

general:
  artifacts:
    - out/atom-mac.zip
    - out/atom-mac-symbols.zip
    - docs/output/atom-api.json

dependencies:
  pre:
    - screencapture $CIRCLE_ARTIFACTS/before-killall.jpg
    - killall ScreenSaverEngine
    - screencapture $CIRCLE_ARTIFACTS/after-killall.jpg
    - curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.31.3/install.sh | bash
    - nvm install 4.4.7
    - nvm use 4.4.7
    - npm install -g npm

  override:
    - script/bootstrap
    - script/build --code-sign --compress-artifacts

  cache_directories:
    - electron
    - apm/node_modules
    - script/node_modules
    - node_modules
    - ~/.atom/compile-cache
    - ~/.nvm

test:
  override:
    - screencapture $CIRCLE_ARTIFACTS/before-tests.jpg
    - caffeinate -u -t 1
    - screencapture $CIRCLE_ARTIFACTS/after-caffeinate.jpg
    - caffeinate -s script/test
